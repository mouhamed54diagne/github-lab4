
name: Multi-stage CI Pipeline

# ğŸš¨ DÃ‰CLENCHEURS - Quand le workflow s'exÃ©cute
on:
  push:
    branches: [ main ]      # Ã€ chaque push sur main
  pull_request:
    branches: [ main ]      # Ã€ chaque PR vers main

jobs:
  # ğŸ“‹ JOB 1: LINTING - VÃ©rification du style de code
  lint:
    name: "ğŸ” Lint Code"
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 1: RÃ©cupÃ©rer le code source
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        
      # Ã‰tape 2: Installer Node.js
      - name: "ğŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'          # ğŸš€ Cache automatique des dÃ©pendances
          
      # Ã‰tape 3: Installer les dÃ©pendances
      - name: "âš™ï¸ Install dependencies"
        run: npm ci
        
      # Ã‰tape 4: ExÃ©cuter le linter
      - name: "âœ… Run linter"
        run: npm run lint

  # ğŸ§ª JOB 2: TESTS & BUILD - Matrix strategy
  test-and-build:
    name: "ğŸ§ª Test & Build (Node ${{ matrix.node-version }} on ${{ matrix.os }})"
    needs: lint              # â³ Attend que le lint soit rÃ©ussi
    runs-on: ${{ matrix.os }}
    
    # ğŸ”„ MATRIX STRATEGY - Teste sur plusieurs environnements
    strategy:
      matrix:
        node-version: [16, 18]                          # 2 versions Node.js
        os: [ubuntu-latest, windows-latest]             # 2 OS diffÃ©rents
        # = 4 jobs au total (2x2 combinaisons)
        
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        
      - name: "ğŸ“¦ Setup Node.js ${{ matrix.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: "âš™ï¸ Install dependencies"
        run: npm ci
        
      # Tests avec couverture de code
      - name: "ğŸ§ª Run tests with coverage"
        run: npm run test:coverage
        
      # Upload des rapports de couverture
      - name: "ğŸ“Š Upload coverage reports"
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.os }}-node${{ matrix.node-version }}
          path: coverage/
          retention-days: 7   # ConservÃ© 7 jours
        
      # Build de l'application
      - name: "ğŸ—ï¸ Build application"
        run: npm run build
        
      # Upload des artifacts de build
      - name: "ğŸ“¦ Upload build artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-node${{ matrix.node-version }}
          path: dist/
          retention-days: 30  # ConservÃ© 30 jours

  # ğŸš€ JOB 3: PRÃ‰PARATION DÃ‰PLOIEMENT - Seulement sur main
  prepare-deployment:
    name: "ğŸš€ Prepare Deployment"
    needs: test-and-build
    runs-on: ubuntu-latest
    # âš ï¸ Seulement sur push vers main (pas sur PR)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # TÃ©lÃ©charge les artifacts de build
      - name: "ğŸ“¥ Download build artifacts"
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-latest-node18  # Version de production
          path: ./build
          
      # CrÃ©e le package de dÃ©ploiement
      - name: "ğŸ“‹ Create deployment package"
        run: |
          mkdir -p deployment
          cp -r build/* deployment/
          echo "Build completed at: $(date)" > deployment/build-info.txt
          echo "Commit SHA: ${{ github.sha }}" >> deployment/build-info.txt
          echo "Build URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> deployment/build-info.txt
          
      # Upload du package final
      - name: "ğŸ¯ Upload deployment package"
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment/
          retention-days: 90  # ConservÃ© 90 jours
